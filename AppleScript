(* 
bit.ly/ä¸‹è¼‰_é±«é°°macOSå¯¦é°£é®¦æ­¥_dmg 
GitHub.com/VirgoEros/ErosRealTimeSync/blob/master/AppleScript 
*)
--------------------------âˆ é±«é°°macOSå¯¦é°£é®¦æ­¥ âˆ----------------------------------ON. 
global ErosSyncMode, OpenScript, SyncMode, ErosRealTimeSync, SyncSource, SyncDest, ErosRealTimeSyncLogsFile, APPitemPath, rsyncPath_ParametersPlus, rsyncPath_ParametersMinus, isDone, itemPath, itemProgress, firstRun, RT_Seconds, RT_Option, RT_Option_HDW, errmsg, errnbr
global ErosSyncMode, firstRun, RT_Seconds, ErosRealTimeSync, rsyncPath_ParametersPlus, SyncSource, SyncDest, ErosRealTimeSyncLogsFile, RT_Option, RT_Option_HDW, errmsg, errnbr
global OpenScript, OpenAppScript, errmsg, errnbr

on run
	try
		tell application "Finder"
			set {button returned:ErosSyncMode} to Â¬
				display dialog {" 
è«‹é°›é°‡é±®ç¾é±ºæ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡ é®¦æ­¥é¸é … å”·ğŸ’‹"} buttons Â¬
					{"é±“æ¬¡é®¦æ­¥&å¯¦é°£é®¦æ­¥", "é–‹å•Ÿè…³æœ¬", "é€€å‡º"} with title Â¬
					{"é±«é°°macOSå¯¦é°£é®¦æ­¥"}
			
			if ErosSyncMode is "é–‹å•Ÿè…³æœ¬" then run script OpenScript
			if ErosSyncMode is "é€€å‡º" then continue quit
			
			if ErosSyncMode is "é±“æ¬¡é®¦æ­¥&å¯¦é°£é®¦æ­¥" then
				set {button returned:SyncMode} to Â¬
					display dialog {" 
è«‹é°›é°‡é±®ç¾é±ºæ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡ é®¦æ­¥é¸é … å”·ğŸ’‹"} buttons Â¬
						{"é±“æ¬¡é®¦æ­¥", "å¯¦é°£é®¦æ­¥"} with title Â¬
						{"é±«é°°macOSå¯¦é°£é®¦æ­¥"}
				set {button returned:ErosRealTimeSync} to Â¬
					display dialog {" 
è«‹é°›é°‡é±®ç¾é±ºæ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡æ¬²é®¦æ­¥ä¹‹æ¨¡å¼å”·ğŸ’‹"} buttons Â¬
						{"é›™å‘A<+>Bé®¦æ­¥", "é±“å‘A+>Bé®¦æ­¥", "é±“å‘A->Bé®¦æ­¥"} with title Â¬
						{"é±«é°°macOSå¯¦é°£é®¦æ­¥"}
				set SyncSource to Â¬
					(choose folder with prompt " 
è«‹æ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡ A:ä¾†æºè³‡æ–™å¤¾ å”·ğŸ’‹" default location (path to (users folder)))
				set SyncDest to Â¬
					(choose folder with prompt " 
è«‹æ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡ B:ç›®æ¨™è³‡æ–™å¤¾ å”·ğŸ’‹" default location (path to (startup disk)))
				set ErosRealTimeSyncLogsFile to Â¬
					(((path to library folder from user domain) as text) & "logs:rsync.txt")
				set APPitemPath to POSIX path of (path to me as text) Â¬
					& {"Contents/MacOS/rsync"}
				set APPitemPath to quoted form of APPitemPath
				set rsyncPath_ParametersPlus to Â¬
					(APPitemPath & " -ESWPaudvxh80AX --stats --exclude={.*,} ")
				set rsyncPath_ParametersMinus to Â¬
					(APPitemPath & " -ESWPaudvxh80AX --delete --stats --exclude={.*,} ")
				if SyncMode is "é±“æ¬¡é®¦æ­¥" then
					if ErosRealTimeSync is "é›™å‘A<+>Bé®¦æ­¥" then
						display notification with title ("é®¦æ­¥ä¸­å”·ğŸ’‹")
						(do shell script Â¬
							rsyncPath_ParametersPlus & Â¬
							quoted form of POSIX path of SyncSource & " " & Â¬
							quoted form of POSIX path of SyncDest)
						(do shell script Â¬
							rsyncPath_ParametersPlus & Â¬
							quoted form of POSIX path of SyncDest & " " & Â¬
							quoted form of POSIX path of SyncSource)
						delay 1
						set isDone to false
						set itemPath to ("rsync ")
						set itemProgress to "ps ax | grep -v grep | grep " & itemPath
						repeat while isDone is false
							try
								do shell script itemProgress
								if the result contains itemPath then
									delay 1
								else
									set isDone to true
								end if
							on error
								set isDone to true
							end try
						end repeat
						if isDone is true then
							display notification with title ("é®¦æ­¥é¯‡æˆé°³å”·ğŸ’‹")
							do shell script ("open " & quoted form of POSIX path of SyncDest)
							continue quit
						end if
					end if
					if ErosRealTimeSync is "é±“å‘A+>Bé®¦æ­¥" then
						display notification with title ("é®¦æ­¥ä¸­å”·ğŸ’‹")
						(do shell script Â¬
							rsyncPath_ParametersPlus & Â¬
							quoted form of POSIX path of SyncSource & " " & Â¬
							quoted form of POSIX path of SyncDest)
						delay 1
						set isDone to false
						set itemPath to ("rsync ")
						set itemProgress to "ps ax | grep -v grep | grep " & itemPath
						repeat while isDone is false
							try
								do shell script itemProgress
								if the result contains itemPath then
									delay 1
								else
									set isDone to true
								end if
							on error
								set isDone to true
							end try
						end repeat
						if isDone is true then
							display notification with title ("é®¦æ­¥é¯‡æˆé°³å”·ğŸ’‹")
							do shell script ("open " & quoted form of POSIX path of SyncDest)
							continue quit
						end if
					end if
					if ErosRealTimeSync is "é±“å‘A->Bé®¦æ­¥" then
						display notification with title ("é®¦æ­¥ä¸­å”·ğŸ’‹")
						(do shell script Â¬
							rsyncPath_ParametersMinus & Â¬
							quoted form of POSIX path of SyncSource & " " & Â¬
							quoted form of POSIX path of SyncDest)
						delay 1
						set isDone to false
						set itemPath to ("rsync ")
						set itemProgress to "ps ax | grep -v grep | grep " & itemPath
						repeat while isDone is false
							try
								do shell script itemProgress
								if the result contains itemPath then
									delay 1
								else
									set isDone to true
								end if
							on error
								set isDone to true
							end try
						end repeat
						if isDone is true then
							display notification with title ("é®¦æ­¥é¯‡æˆé°³å”·ğŸ’‹")
							do shell script ("open " & quoted form of POSIX path of SyncDest)
							continue quit
						end if
					end if
				end if
				if SyncMode is "å¯¦é°£é®¦æ­¥" then
					set firstRun to true
					set RT_Seconds to ("")
					set {button returned:RT_Option} to Â¬
						display dialog {" 
è«‹é°›é°‡é±®ç¾é±ºæ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡ é®¦æ­¥é–“éš”é±“ä½ å”·ğŸ’‹"} buttons Â¬
							{"ç§’", "é­µ", "é°£ æ—¥ é€±"} with title Â¬
							{"é±«é°°macOSå¯¦é°£é®¦æ­¥"}
					if RT_Option is "ç§’" then return RT_Seconds
					if RT_Option is "é­µ" then return {RT_Seconds * minutes}
					if RT_Option is "é°£ æ—¥ é€±" then
						set {button returned:RT_Option_HDW} to Â¬
							display dialog {" 
è«‹é°›é°‡é±®ç¾é±ºæ²ç™‚ç™’é¯€å¥³é°°é¸æ“‡ é®¦æ­¥é–“éš”é±“ä½ å”·ğŸ’‹"} buttons Â¬
								{"é°£", "æ—¥", "é€±"} with title Â¬
								{"é±«é°°macOSå¯¦é°£é®¦æ­¥"}
						if RT_Option_HDW is "é°£" then return {RT_Seconds * hours}
						if RT_Option_HDW is "æ—¥" then return {RT_Seconds * days}
						if RT_Option_HDW is "é€±" then return {RT_Seconds * weeks}
					end if
				end if
			end if
		end tell
	on error errmsg number errnbr
		if errnbr = -128 then continue quit
		continue quit
	end try
end run

on idle
	try
		if SyncMode is "å¯¦é°£é®¦æ­¥" then
			if firstRun then
				tell application "Finder" to display dialog {"è«‹æ²å¥³é°°é°é­é–“éš”æ•¸å­—ï¼Œå€˜é°™é°¡ç©ºé±‚ä»¥æœ€å°é–“éš”å€¼é®¦æ­¥å”·ğŸ’‹"} default answer ("") with title Â¬
					{"é±«é°°macOSå¯¦é°£é®¦æ­¥"}
				set RT_Seconds to ((text returned of the result) as integer)
				if RT_Seconds is "" then return continue quit
				set firstRun to false
			else
				try
					if ErosRealTimeSync is "é›™å‘A<+>Bé®¦æ­¥" then
						(do shell script Â¬
							rsyncPath_ParametersPlus & Â¬
							quoted form of POSIX path of SyncSource & " " & Â¬
							quoted form of POSIX path of SyncDest & " >> " & Â¬
							quoted form of POSIX path of ErosRealTimeSyncLogsFile)
						(do shell script Â¬
							rsyncPath_ParametersPlus & Â¬
							quoted form of POSIX path of SyncDest & " " & Â¬
							quoted form of POSIX path of SyncSource & " >> " & Â¬
							quoted form of POSIX path of ErosRealTimeSyncLogsFile)
					end if
					if ErosRealTimeSync is "é±“å‘A+>Bé®¦æ­¥" then
						(do shell script Â¬
							rsyncPath_ParametersPlus & Â¬
							quoted form of POSIX path of SyncSource & " " & Â¬
							quoted form of POSIX path of SyncDest & " >> " & Â¬
							quoted form of POSIX path of ErosRealTimeSyncLogsFile)
					end if
					if ErosRealTimeSync is "é±“å‘A->Bé®¦æ­¥" then
						(do shell script Â¬
							rsyncPath_ParametersMinus & Â¬
							quoted form of POSIX path of SyncSource & " " & Â¬
							quoted form of POSIX path of SyncDest & " >> " & Â¬
							quoted form of POSIX path of ErosRealTimeSyncLogsFile)
					end if
				end try
			end if
			if firstRun is "" then return seconds
			if RT_Option is "ç§’" then return RT_Seconds
			if RT_Option is "é­µ" then return {RT_Seconds * minutes}
			if RT_Option_HDW is "é°£" then return {RT_Seconds * hours}
			if RT_Option_HDW is "æ—¥" then return {RT_Seconds * days}
			if RT_Option_HDW is "é€±" then return {RT_Seconds * weeks}
		end if
	on error errmsg number errnbr
		if errnbr = -128 then continue quit
	end try
end idle
------------------------ é–‹å•Ÿè…³æœ¬ ------------------------ON. 
script OpenScript
	try
		set OpenAppScript to POSIX path of (path to me as text) & ("Contents/Resources/Scripts/main.scpt")
		set OpenAppScript to quoted form of OpenAppScript
		do shell script ("open " & OpenAppScript)
		display notification with title ("è…³æœ¬å·²é–‹å•Ÿé°³å”·ğŸ’‹")
		continue quit
	on error errmsg number errnbr
		if errnbr = -128 then continue quit
		continue quit
	end try
end script
--------------------------âˆ é±«é°°macOSå¯¦é°£é®¦æ­¥ âˆ------------------------------END. 


-- 
